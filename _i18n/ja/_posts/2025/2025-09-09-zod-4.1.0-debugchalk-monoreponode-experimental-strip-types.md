---
title: "2025-09-09のJS: Zod 4.1.0、`debug`や`chalk`パッケージの侵害、monorepoなアプリを`node --experimental-strip-types`へ移行"
author: "azu"
layout: post
date: 2025-09-09T09:02:57.249Z
category: JSer
tags:
- TypeScript
- nodejs
- browser
- npm
- security

---

JSer.info #747 - Zod 4.1.0がリリースされ、新しいCodecs APIが追加されました。

- [Release v4.1.0 · colinhacks/zod](https://github.com/colinhacks/zod/releases/tag/v4.1.0)
- [Introducing Zod Codecs](https://colinhacks.com/essays/introducing-zod-codecs)

スキーマの定義に加えて、データのencode/decodeを定義できるCodecs APIが新たに追加されています。また、`.safeExtend()`メソッド、`z.has()`や`z.hex()`の新しいバリデーション関数も追加されています。

---

`debug`や`chalk`などの著名なnpmパッケージが侵害され、マルウェアを含むバージョンが公開されるという問題が発生しました。
現在はnpm registryから該当バージョンは削除されています。

- [npm debug and chalk packages compromised](https://www.aikido.dev/blog/npm-debug-and-chalk-packages-compromised)
- パッケージオーナーのコメント: <https://github.com/debug-js/debug/issues/1005#issuecomment-3266868187>

影響を受けたパッケージには`debug@4.4.2`、`chalk@5.6.1`、`ansi-styles@6.2.2`などが含まれており、該当のバージョンではブラウザで動作するマルウェアが仕込まれていました。現在は該当バージョンがnpm registryから削除されています。

マルウェアとなったバージョンが依存に入ってるかは、次のコマンドで確認できます。

```bash
# npm - 結果が空なら影響なし
npm list "ansi-styles@6.2.2" "debug@4.4.2" "chalk@5.6.1" "supports-color@10.2.1" "strip-ansi@7.1.1" "ansi-regex@6.2.1" "wrap-ansi@9.0.1" "color-convert@3.1.1" "color-name@2.0.1" "is-arrayish@0.3.3" "slice-ansi@7.1.1" "color@5.0.1" "color-string@2.1.1" "simple-swizzle@0.2.3" "supports-hyperlinks@4.1.1" "has-ansi@6.0.1" "chalk-template@1.1.1" "backslash@0.2.1"

# pnpm - 結果が空なら影響なし
pnpm list --depth=Infinity "ansi-styles@6.2.2" "debug@4.4.2" "chalk@5.6.1" "supports-color@10.2.1" "strip-ansi@7.1.1" "ansi-regex@6.2.1" "wrap-ansi@9.0.1" "color-convert@3.1.1" "color-name@2.0.1" "is-arrayish@0.3.3" "slice-ansi@7.1.1" "color@5.0.1" "color-string@2.1.1" "simple-swizzle@0.2.3" "supports-hyperlinks@4.1.1" "has-ansi@6.0.1" "chalk-template@1.1.1" "backslash@0.2.1"

# yarnはlistコマンドがない
```

マルウェアが`node_modules`やビルドファイルなどにないかは、次のコマンドで確認できます。

```bash
# ripgrepが必要です
rg -uu --max-columns=80 --glob '*.js' _0x112fa8 
```

- https://github.com/chalk/chalk/issues/656#issuecomment-3266880534

今回の問題では、パッケージオーナーはnpmの2要素認証を有効にしていましたが、攻撃者はフィッシング（フィッシングサイト上でTOTPも入力させる）を利用して有効なnpm tokenを取得し、悪意のあるバージョンを公開したようです。

- https://news.ycombinator.com/item?id=45172742

---

次の記事では、npmのTrusted PublishingとOIDCを使い、CIからnpm tokenを使わずにパッケージを公開する方法が紹介されています。

- [npm Trusted PublishingでOIDCを使ってトークンレスでCIからnpmパッケージを公開する | Web Scratch](https://efcl.info/2025/09/07/npm-oidc/)

npm Trusted Publishingの設定方法、GitHub ActionsでのOIDC設定、単体/monorepoパッケージの運用方法、GitHubのProtectionの設定などについても解説されています。
また、npmの[Require two-factor authentication and disallow tokens](https://docs.npmjs.com/requiring-2fa-for-package-publishing-and-settings-modification)の設定について書かれています。
"Require two-factor authentication and disallow tokens" が有効なパッケージは、パッケージの公開にも2要素認証が必要になるため、npmのアカウントを乗っ取られた場合にも複数回のMFA認証が必要となり、被害を軽減できる可能性があります。

---

Node.jsとTypeScriptで書かれたmonorepoアプリケーションを`node --experimental-strip-types`へ移行した事例が紹介されています。

- [How we migrated our Rush.js monorepo to Node type stripping](https://blog.calm.com/engineering/how-we-migrated-our-rushjs-monorepo-to-node-type-stripping)

monorepoと`node_modules`内のコードに対して`--experimental-strip-types`が効かない問題を、`--conditions`フラグでパス解決を調整することで解決しています。ESMへの移行、stub作成、CommonJSの対応、`erasableSyntaxOnly`設定による未対応構文の対応などを行っています。TypeScriptコードを直接実行できるようにした具体的な手順が詳しく説明されています。

[Node.js v22.18.0 (LTS)](https://nodejs.org/en/blog/release/v22.18.0)で`--experimental-strip-types`はフラグが外れ、デフォルトでNode.jsがTypeScriptファイルを実行できるようになっています。


----

{% include inline-support.html %}

----

<h1 class="site-genre">ヘッドライン</h1>

----

## Release v4.1.0 · colinhacks/zod
[github.com/colinhacks/zod/releases/tag/v4.1.0](https://github.com/colinhacks/zod/releases/tag/v4.1.0 "Release v4.1.0 · colinhacks/zod")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">JavaScript</span> <span class="jser-tag">TypeScript</span> <span class="jser-tag">library</span> <span class="jser-tag">ReleaseNote</span></p>

zod 4.1.0リリース。
encode/decodeを定義するCodecs APIを追加、`.safeExtend()`を追加、`z.has()`/`z.hex()`を追加など

- [Introducing Zod Codecs](https://colinhacks.com/essays/introducing-zod-codecs "Introducing Zod Codecs")

----

## Fresh 2.0 Graduates to Beta, Adds Vite Support | Deno
[deno.com/blog/fresh-and-vite](https://deno.com/blog/fresh-and-vite "Fresh 2.0 Graduates to Beta, Adds Vite Support | Deno")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">deno</span> <span class="jser-tag">vite</span> <span class="jser-tag">ReleaseNote</span></p>

Fresh 2.0 Betaリリース。
Viteを使ったHMRの対応、`react`のaliasの対応、`<Head>`の追加など


----

## Nuxt 4.1 · Nuxt Blog
[nuxt.com/blog/v4-1](https://nuxt.com/blog/v4-1 "Nuxt 4.1 · Nuxt Blog")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">Vue</span> <span class="jser-tag">library</span> <span class="jser-tag">ReleaseNote</span></p>

Nuxt v4.1リリース。
Import Mapを使ったchunkのキャッシュの改善、実験的なRolldownのサポート、`getLayerDirectories`の追加など


----
<h1 class="site-genre">アーティクル</h1>

----

## fetch() では Host ヘッダーを設定できないし話はそこまで単純じゃない - Object.create(null)
[susisu.hatenablog.com/entry/2025/08/31/190757](https://susisu.hatenablog.com/entry/2025/08/31/190757 "fetch() では Host ヘッダーを設定できないし話はそこまで単純じゃない - Object.create(null)")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">browser</span> <span class="jser-tag">Fetch</span> <span class="jser-tag">nodejs</span> <span class="jser-tag">article</span></p>

Fetch APIとHostヘッダーについて。
サーバサイドの実行環境であるNode.js/Deno/Claudflare Workersなどの挙動について


----

## tsx と Node.js Type Stripping の違い - mizdra&#039;s blog
[www.mizdra.net/entry/2025/08/28/122040](https://www.mizdra.net/entry/2025/08/28/122040 "tsx と Node.js Type Stripping の違い - mizdra&#039;s blog")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">TypeScript</span> <span class="jser-tag">article</span></p>

`tsx`パッケージとNode.jsのType Strippingの挙動の違いについて


----

## Why I Won’t Use JSDOM | Epic Web Dev
[www.epicweb.dev/why-i-won-t-use-jsdom](https://www.epicweb.dev/why-i-won-t-use-jsdom "Why I Won’t Use JSDOM | Epic Web Dev")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">JavaScript</span> <span class="jser-tag">DOM</span> <span class="jser-tag">test</span> <span class="jser-tag">article</span></p>

JSDOMの制限とブラウザでのコンポーネントテストについて


----

## npm Trusted PublishingでOIDCを使ってトークンレスでCIからnpmパッケージを公開する | Web Scratch
[efcl.info/2025/09/07/npm-oidc/](https://efcl.info/2025/09/07/npm-oidc/ "npm Trusted PublishingでOIDCを使ってトークンレスでCIからnpmパッケージを公開する | Web Scratch")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">npm</span> <span class="jser-tag">security</span> <span class="jser-tag">article</span></p>

npm Trusted PublishingとOIDCによるトークンレスなCI/CDからのnpmパッケージ公開について。
設定手順、ブラウザで完結するリリースフロー、
新規/既存/monorepoパッケージの運用方法、GitHubのProtectionの設定などについて


----

## npm debug and chalk packages compromised
[www.aikido.dev/blog/npm-debug-and-chalk-packages-compromised](https://www.aikido.dev/blog/npm-debug-and-chalk-packages-compromised "npm debug and chalk packages compromised")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">npm</span> <span class="jser-tag">security</span> <span class="jser-tag">article</span></p>

`debug`や`chalk`など著名なnpmパッケージにブラウザで動作するマルウェアを含むバージョンが公開された問題について。

現在はnpm registryから該当のバージョンは削除されている。
次のパッケージのバージョン影響を受けていた。

```
ansi-styles@6.2.2
debug@4.4.2
chalk@5.6.1
supports-color@10.2.1
strip-ansi@7.1.1
ansi-regex@6.2.1
wrap-ansi@9.0.1
color-convert@3.1.1
color-name@2.0.1
is-arrayish@0.3.3
slice-ansi@7.1.1
color@5.0.1
color-string@2.1.1
simple-swizzle@0.2.3
supports-hyperlinks@4.1.1
has-ansi@6.0.1
chalk-template@1.1.1
backslash@0.2.1
```

- [(RESOLVED) Version 4.4.2 published to npm is compromised · Issue #1005 · debug-js/debug](https://github.com/debug-js/debug/issues/1005#issuecomment-3266868187 "(RESOLVED) Version 4.4.2 published to npm is compromised · Issue #1005 · debug-js/debug")
- [npm debug, color-convert, backslash, error-ex, simple-swizzle, is-arrayish, color-name, color-string have incorrect wildcard version in their malware advisory (2025-09-08) · Issue #6099 · github/advisory-database](https://github.com/github/advisory-database/issues/6099 "npm debug, color-convert, backslash, error-ex, simple-swizzle, is-arrayish, color-name, color-string have incorrect wildcard version in their malware advisory (2025-09-08) · Issue #6099 · github/advisory-database")

----

## Bringing Node.js HTTP servers to Cloudflare Workers
[blog.cloudflare.com/bringing-node-js-http-servers-to-cloudflare-workers/](https://blog.cloudflare.com/bringing-node-js-http-servers-to-cloudflare-workers/ "Bringing Node.js HTTP servers to Cloudflare Workers")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">cloudflare</span> <span class="jser-tag">nodejs</span> <span class="jser-tag">article</span></p>

Cloudflare WorkersのNode.js `http` serverの対応について。


----

## How we migrated our Rush.js monorepo to Node type stripping — Calm Blog
[blog.calm.com/engineering/how-we-migrated-our-rushjs-monorepo-to-node-type-stripping](https://blog.calm.com/engineering/how-we-migrated-our-rushjs-monorepo-to-node-type-stripping "How we migrated our Rush.js monorepo to Node type stripping — Calm Blog")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">nodejs</span> <span class="jser-tag">TypeScript</span> <span class="jser-tag">article</span></p>

TypeScriptで書かれたNode.jsアプリケーションのコードベースをどのようにtype strippingに移行したかについて。
monorepoと`node_modules`にコードがあるため、`node --experimental-strip-types`が効かないが、`--conditions`で参照するパスを解決している。
ESMへの移行、stub、CJSの対応、`erasableSyntaxOnly`で未対応の構文の対応などを行い、`node --experimental-strip-types`で実行できるようにした話。


----
<h1 class="site-genre">スライド、動画関係</h1>

----

## 1から理解するWeb Push - Speaker Deck
[speakerdeck.com/dora1998/1karali-jie-suruweb-push](https://speakerdeck.com/dora1998/1karali-jie-suruweb-push "1から理解するWeb Push - Speaker Deck")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">browser</span> <span class="jser-tag">WebPlatformAPI</span> <span class="jser-tag">slide</span></p>

Web PushとPush Serviceについて。
Web Pushがどのように動いてるのか、ブラウザベンダーのPush Serverの実装についてなど


----
<h1 class="site-genre">書籍関係</h1>

----

## JavaScript/TypeScript実力強化書 | 技術評論社
[gihyo.jp/book/2025/978-4-297-15194-2](https://gihyo.jp/book/2025/978-4-297-15194-2 "JavaScript/TypeScript実力強化書 | 技術評論社")
<p class="jser-tags jser-tag-icon"><span class="jser-tag">JavaScript</span> <span class="jser-tag">TypeScript</span> <span class="jser-tag">book</span></p>

2025年9月29日発売
JavaScript/TypeScriptについての書籍


----
